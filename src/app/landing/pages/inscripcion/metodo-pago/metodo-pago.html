<form #pagoForm="ngForm" (ngSubmit)="submitPago(pagoForm)" novalidate>
    <div class="row justify-content-center">
        <div class="col-lg-7">
            <div class="card p-4 shadow-sm mb-4" style="background-color: #f8f1e9;">

                <h3 class="mb-4 text-primary"><i class="bi bi-credit-card-fill me-2"></i>3. Método de Pago</h3>

                <p class="text-muted small">Datos de tarjeta para el pago final.</p>

                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="numeroTarjeta" class="form-label">Número de Tarjeta</label>
                        <input type="text" class="form-control" id="numeroTarjeta" name="numeroTarjeta"
                            placeholder="XXXX XXXX XXXX XXXX" required maxlength="19" pattern="[\d\s\-]{15,19}"
                            [(ngModel)]="datos.numeroTarjeta">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento</label>
                        <input type="text" class="form-control" id="fechaVencimiento" name="fechaVencimiento"
                            placeholder="MM/AA" required maxlength="5" pattern="(0[1-9]|1[0-2])\/[0-9]{2}"
                            [(ngModel)]="datos.fechaVencimiento">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="cvv" class="form-label">CVV / CVC</label>
                        <input type="text" class="form-control" id="cvv" name="cvv" placeholder="XXX" required
                            maxlength="4" pattern="\d{3,4}" [(ngModel)]="datos.cvv">
                        <small class="form-text text-muted">3 o 4 dígitos en el reverso.</small>
                    </div>
                </div>

                <hr class="my-4">
                @if (!isSelectionValid()) {
                <div class="alert alert-danger">
                    ⚠️ **Error de Flujo:** Debes regresar al Paso 2 y seleccionar tus talleres/horarios.
                </div>
                }
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card p-4 shadow-sm h-100" style="background-color: #e6e0d9;">
                <h4 class="mb-4 fw-bold text-center">Resumen de Inscripción y Pago</h4>

                <div class="table-responsive mb-4">
                    <table class="table table-sm align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Taller</th>
                                <th scope="col">Horario</th>
                                <th scope="col" class="text-end">Precio</th>
                            </tr>
                        </thead>
                        <tbody id="resumenBody">
                            @for (item of talleresSeleccionados(); track item.id) {
                            <tr [class.table-warning]="!item.horarioSeleccionadoId">
                                <td>{{ item.nombre }}</td>

                                <td>
                                    @if (item.horarioSeleccionado) {
                                    <span class="text-muted small">
                                        {{ item.horarioSeleccionado.diasDeClase }}
                                        ({{ item.horarioSeleccionado.horaInicio }} - {{ item.horarioSeleccionado.horaFin
                                        }})
                                    </span>
                                    } @else {
                                    <span class="text-danger small">Horario faltante</span>
                                    }
                                </td>

                                <td class="text-end fw-medium">S/ {{ item.precio | number : '1.2-2' }}</td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <ul class="list-group list-group-flush mb-4">
                    <li class="list-group-item d-flex justify-content-between bg-light fw-bold">
                        <span>Total a Pagar:</span>
                        <span class="text-success fs-5">S/ {{ totalPagar() | number : '1.2-2' }}</span>
                    </li>
                </ul>

                <p class="text-success small"><i class="bi bi-shield-lock-fill me-2"></i>Pago 100% seguro con cifrado
                    SSL.</p>

                <div class="d-grid mt-3">
                    <button type="submit" class="btn-formulario btn-lg"
                        [disabled]="pagoForm.invalid || totalPagar() <= 0 || isLoading || !isSelectionValid()">
                        {{ isLoading ? 'Procesando Pago...' : 'Pagar S/ ' + (totalPagar() | number : '1.2-2') + ' y Confirmar Inscripción' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>